{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}
<section class="pt-5 pb-5">
  <div class="container">
    <div class="section-title text-center">
      <h2>üëã Bonjour {{ user.name }}</h2>
      <p>Bienvenue sur votre tableau de bord</p>
    </div>

    {% if user.is_authenticated and user.role == 'prestataire' and user.signalements.exists %}
      <div class="text-center mb-4">
        <a href="{% url 'mes_signalements' %}" class="btn btn-outline-danger">üì© Plaintes re√ßues</a>
      </div>
    {% endif %}

    {% if user.role == 'client' %}
      <div class="row gy-4 justify-content-center">
        <div class="col-md-4">
          <div class="icon-box text-center">
            <h4>{{ reservations|length }}</h4>
            <p>R√©servations effectu√©es</p>
          </div>
        </div>
        {% if dernier_avis %}
        <div class="col-md-4">
          <div class="icon-box text-center">
            <h4>{{ dernier_avis.note }}/5</h4>
            <p>Derni√®re note donn√©e</p>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="text-center mt-4">
        <a href="{% url 'page_services' %}" class="btn btn-primary me-2">Faire une demande</a>
        <a href="{% url 'mes_reservations' %}" class="btn btn-outline-secondary">Mes demandes</a>
      </div>
    {% elif user.role == 'prestataire' %}
      {% if has_prestataire_profile %}
        <div class="row gy-4 justify-content-center">
          <div class="col-md-4">
            <div class="icon-box text-center">
              <h4>{{ services|length }}</h4>
              <p><a href="{% url 'mes_services' %}">Services propos√©s</a></p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="icon-box text-center">
              <h4>{{ demandes|length }}</h4>
              <p><a href="{% url 'mes_reservations_prestataire' %}">Demandes re√ßues</a></p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="icon-box text-center">
              <h4>{{ note_moyenne }}</h4>
              <p>Note moyenne ‚òÖ</p>
            </div>
          </div>
        </div>

        <div class="mt-5">
          <h4>üìã Vos services</h4>
          <ul class="list-group">
            {% for s in services %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ s.service.nom }}</strong><br>
                  {{ s.description|truncatewords:15 }}<br>
                  <em>{{ s.prix }} FCFA</em>
                </div>
                <div>
                  <a href="{% url 'modifier_service' s.id %}" title="Modifier">
                    <i class="bi bi-pencil-square me-2"></i>
                  </a>
                  <form action="{% url 'supprimer_service' s.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('Supprimer ce service ?');" style="background:none; border:none;">
                      <i class="bi bi-trash text-danger"></i>
                    </button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="mt-4 d-flex gap-2 flex-wrap justify-content-center">
          <a href="{% url 'ajouter_service_offert' %}" class="btn btn-primary">+ Ajouter un service</a>
          <a href="{% url 'mes_reservations_prestataire' %}" class="btn btn-outline-secondary">üì® Demandes</a>
          <a href="{% url 'boite_reception_prestataire' %}" class="btn btn-outline-primary">
            <i class="bi bi-inbox"></i> Messages
          </a>
          <a href="{% url 'messages_admin_prestataire' user.prestataire.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-chat-dots"></i> Contacter admin
          </a>
        </div>
      {% else %}
        <div class="alert alert-warning text-center mt-4">
          ‚ö†Ô∏è Vous devez compl√©ter votre profil de prestataire.
        </div>
        <div class="text-center">
          <a href="{% url 'completer_profil_prestataire' %}" class="btn btn-primary">Compl√©ter le profil</a>
        </div>
      {% endif %}
    {% endif %}

    <!-- Notifications -->
    <div class="mt-5">
      <h4>üîî Notifications</h4>
      {% if notifications %}
        <ul class="list-group mb-3">
          {% for notif in notifications %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {{ notif.message }}<br>
                <small class="text-muted">{{ notif.date|date:"d/m/Y H:i" }}</small>
              </div>
              <a href="{% url 'marquer_notification_lue' notif.id %}" class="btn btn-sm btn-outline-success">‚úî Marquer lue</a>
            </li>
          {% endfor %}
        </ul>
        <a href="{% url 'marquer_tout_lu' %}" class="btn btn-secondary">‚úî Tout marquer comme lu</a>
      {% else %}
        <p class="text-muted">Aucune notification.</p>
      {% endif %}

      <div class="mt-3">
        <a href="{% url 'historique_notifications' %}">üìú Historique complet</a>
      </div>

      {% if notifications_auto %}
        <div class="alert alert-info mt-3">
          <ul class="mb-0">
            {% for notif in notifications_auto %}
              <li>
                {{ notif.message }}
                <a href="{% url 'marquer_notification_lue' notif.id %}" class="btn btn-sm btn-link">Marquer comme lue</a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>

    <!-- Statistiques -->
    <div class="mt-5 text-center">
      {% if has_prestataire_profile %}
        <h4>üìà Statistiques</h4>
        <p>Analysez vos performances.</p>
        <a href="{% url 'statistiques' %}" class="btn btn-primary">üìä Voir les stats</a>
      {% else %}
        {% if user.role == 'prestataire' %}
          <div class="alert alert-warning">
            ‚ö†Ô∏è Compl√©tez votre profil pour acc√©der aux statistiques.
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
