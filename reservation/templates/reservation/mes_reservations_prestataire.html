{% extends "base.html" %}
{% block title %}R√©servations re√ßues{% endblock %}

{% block content %}
<section id="reservations" class="team section">
  <div class="container">
    <div class="section-title">
      <h2>R√©servations re√ßues</h2>
    </div>

    {% if reservations %}
      <div class="row gy-4">
        {% for r in reservations %}
          <div class="col-lg-4 col-md-6 d-flex align-items-stretch">
            <div class="member w-100">
              <div class="member-content">
                <h4>{{ r.client.name }}</h4>
                <p><strong>Service :</strong> {{ r.service_offert.service.nom }}</p>
                <p><strong>Date :</strong> {{ r.date }} √† {{ r.heure }}</p>

                <p>
                  <strong>Statut :{{ r.get_statut_display }}</strong>
                  <span class="badge 
                    {% if r.statut == 'en_attente' %} bg-warning text-dark
                    {% elif r.statut == 'accept√©e' %} bg-success
                    {% elif r.statut == 'refus√©e' %} bg-danger
                    {% elif r.statut == 'termin√©e' %} bg-primary
                    {% elif r.statut == 'en_attente_confirmation' %} bg-info
                    {% elif r.statut == 'report√©e' %} bg-secondary
                    {% endif %}">
                    {{ r.get_statut_display }}
                  </span>
                </p>

                {% if r.statut == 'en_attente' %}
                  <form method="POST" action="{% url 'action_reservation' r.id 'accepter' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-success btn-sm">Accepter</button>
                  </form>
                  <form method="POST" action="{% url 'action_reservation' r.id 'refuser' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">Refuser</button>
                  </form>
                {% elif r.statut == 'accept√©e' %}
                  <form method="POST" action="{% url 'changer_statut_reservation' r.id 'termin√©e' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm mt-2">‚úÖ Marquer comme termin√©e</button>
                  </form>
                {% endif %}

                {% if r.statut == 'en_attente' or r.statut == 'accept√©e' %}
                  <a href="{% url 'reporter_reservation' r.id %}" class="btn btn-warning btn-sm mt-2">Reporter</a>
                {% endif %}

                {% if r.statut == 'en_attente_confirmation' and r.nouvelle_date and r.nouvelle_heure and user != r.reporteur %}
                  <p class="mt-2">Nouvelle date propos√©e : <strong>{{ r.nouvelle_date }}</strong> √† <strong>{{ r.nouvelle_heure }}</strong></p>
                  <a href="{% url 'confirmer_report' r.id %}" class="btn btn-success btn-sm">Confirmer</a>
                  <a href="{% url 'refuser_report' r.id %}" class="btn btn-danger btn-sm">Refuser</a>
                {% endif %}

                {% if r.statut == 'report√©e' %}
                  <p class="mt-2"><em>Date report√©e : <strong>{{ r.date }}</strong> √† <strong>{{ r.heure }}</strong></em></p>
                  <a href="{% url 'reporter_reservation' r.id %}" class="btn btn-warning btn-sm mt-2">Reporter</a>
                {% endif %}

                <!-- Bouton pour acc√©der √† la messagerie li√©e √† la r√©servation -->
                <a href="{% url 'messages_reservation' r.id %}" class="btn btn-primary btn-sm mt-2">
                  üí¨ Voir la conversation
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>Aucune r√©servation re√ßue pour le moment.</p>
    {% endif %}
  </div>
</section>
{% endblock %}


